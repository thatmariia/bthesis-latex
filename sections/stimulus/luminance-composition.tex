\subsection{Luminance stimulus composition}

\paragraph{Annulus composition}

First, a single annulus with maximal contrast is generated. Let $\hat{d} \in \mathbb{R}_+, d > 0$ be the diameter of an annulus in visual degrees and $d \in \mathbb{N}$ be the resolution of the grating. Let $\atopix: \mathbb{R_+ \to \mathbb{N}_0}$ be a function transforming a value in the physical space to the corresponding pixel value:
\begin{equation}
    \atopix(x) = \ceil{\frac{d}{\hat{d}} \cdot x}.
\end{equation}
Let $\Omega \in \mathbb{R}_+$ be  the spatial frequency in cycles per degree of the visual field and $A \in [0, 1]^{\res \times \res}$ - the pixel luminance matrix of the annulus. 

Let $R \in \mathbb{R}_+^{d \times d}$ be a matrix containing the distances (radii) of each pixel from the middle of the matrix. Then, for $i, j \in \{ 0, 1, \cdots,  d-1 \}$,
\begin{equation}
    R_{i, j} = \cdot \left\| (0, 0), \ \left(-\frac{\hat{d}}{2} + \frac{\hat{d}}{d - 1} i, -\frac{\hat{d}}{2} + \frac{\hat{d}}{d - 1} j \right) \right\|.
\end{equation}

Now, for all pixels $A_{i, j}$ in $A$, 
\begin{equation}
    A_{i, j} = \vlum \cdot
    \begin{cases}
        \cos(2 \pi R_{i, j} \Omega + \pi) &\text{ if } R_{i, j} \leq \frac{\hat{d}}{2} \\
        1 &\text{ otherwise}
    \end{cases},
    \label{eq:grating}
\end{equation}
where $\vlum \in (0, 1)$ is luminance of the void (the area uncovered by the annulus).
An example of the resulting luminance matrix' binary heat map is visualized in Figure \ref{fig:grating-example}. The number of pixels covered by the annulus is then
\begin{equation}
    \nrann = \left| \left\{ i, j \in \mathbb{N}_0 \ | \ R_{i, j} \leq \frac{\hat{d}}{2} \right\} \right|.
\end{equation}

\begin{figure}[!htp]
    \centering
    \includegraphics[width=0.2\textwidth]{assets/images/grating.png}
    \caption{An example of the annulus with $\res = 50$.}
    \label{fig:grating-example}
\end{figure}


\paragraph{Texture composition}

Then, such Gabor annuli of various contrasts are arranged in a square grid with a side length $\hat{\ell_\full} \in \mathbb{R}_+, \hat{\ell_\full} \geq \hat{d}$ measured in visual degrees. The distance between the centers of neighboring annuli is $k \cdot \hat{d}$, and then the pixel distance is 
\begin{equation}
    d_\full = \ceil{k \cdot d},
\end{equation}
where $k \in [1, \infty)$, so that they do not overlap. The variable $d_\full$ then also indicates the number of pixels allocated to each annulus and void around it. Then, each row and column of the grid contain that many annuli:
\begin{equation}
    \reps = \ceil{\frac{\hat{\ell_\full}}{k \cdot \hat{d}}}.
\end{equation}
Therefore, the matrix allocated for this grid can be defined as $L_{\full} \in \left( [0, 1]^{ d_\full \times d_\full} \right)^{\reps \times \reps}$. The size of the matrix is $\ell_\full \times \ell_\full$, where 
\begin{equation}
    \ell_\full = d_\full \cdot \reps,
\end{equation}
and the center of the matrix $O_{L_\full}$ is
\begin{equation}
    O_{L_\full} = \left( \ceil{\frac{\ell_\full}{2}}, \ \ceil{\frac{\ell_\full}{2}} \right).
\end{equation}
The luminance values of the void (areas uncovered by the annuli) of the matrix $L_\full$ are initialized with the value of $\vlum$. 

As mentioned above, the matrix includes a figure and the background. The figure represents a rectangular submatrix $F$ of $L_\full$, and the rest of $L_\full$ constitutes the background. The center of the figure is located at an eccentricity of $\hat{\ecc_F}$ at an angle $\theta$ to the horizontal axis.
Therefore, the location of the center $O_F$ of the figure $F$ in $L_\full$ is
\begin{equation}
    O_F = O_{L_\full} + (\atopix( \cdot \hat{\ecc_F} \cdot \cos(\theta)), \ \atopix( \cdot \hat{\ecc_F} \cdot \sin(\theta))).
\end{equation}
The size of the figure is $\hat{\ell_{F_w}} \times \hat{\ell_{F_h}}$ in visual degrees. Therefore, in pixels, the size of $F$ is
\begin{equation}
    \left( \ell_{F_w} = \atopix(\hat{\ell_{F_w})} \right) \times \left( \ell_{F_h} = \atopix(\hat{\ell_{F_h}}) \right).
\end{equation}
The figure is contained in the bottom right quadrant of the stimulus. Thus, $\theta \in [\sin^{-1} (\frac{\hat{\ell_{F_h}}}{2 \cdot \hat{\ecc_F}}), \frac{\pi}{2} - \cos^{-1} (\frac{\hat{\ell_{F_w}}}{2 \cdot \hat{\ecc_F}})]$. \todo{is the angle selected randomly?} So,
\begin{equation}
    F =
    \begin{pmatrix}
        L_{\full; \ceil{O_F - \frac{1}{2} \ell_{F_w}},  \ceil{O_F - \frac{1}{2} \ell_{F_h}}} &  &  \\
         & \ddots &  \\
         &  & L_{\full; \ceil{O_F - \frac{1}{2} \ell_{F_w}} + \ell_{F_w},  \ceil{O_F - \frac{1}{2} \ell_{F_h}} + \ell_{F_w}}
    \end{pmatrix}.
\end{equation}

While the annuli on the background vary in contrast in a uniform range $[0, 1]$, the ones on the figure share similar contrasts, as mentioned above. Let $\fancyA$ be the set containing all matrices associated with annuli in $L_\full$. Then $|\fancyA| = \reps^2$ and 
\begin{equation}
    \fancyA \coloneqq \bigcup_{i = 0}^{\reps - 1} \bigcup_{j = 0}^{\reps - 1}
    \begin{pmatrix}
        L_{\full; d_\full \cdot i, d_\full \cdot j} &  &  \\
         & \ddots & \\
         &  & L_{\full; d_\full \cdot (i+1), d_\full \cdot (j+1)}
    \end{pmatrix}.
\end{equation}
Let $A \in \fancyA$. The coordinate of the top left pixel of the annulus in $A$ is $\frac{d_\full - d}{2}$. Let $\annulus: \fancyA \to \mathbb{N}^{2 \times \nrann}$ be the function mapping from a matrix containing an annulus to the pixel coordinates of that annulus. Let $\view : \annulus \to \{ \foreground, \background \}$ be the function mapping an annulus to its view: if $\annulus(A), A \in \fancyA$, is (partly) contained in $F$ (the intersection of their coordinates in $L_\full$ is non-empty), the annulus is thought to belong to the figure, otherwise, - to the background. \todo{is this true?}

Let $\eta \in (0, 1]$ be the range of contrasts for the foreground, and let $\unirand: \fancyA \to U(0, 1)$ be a random value that varies per annulus. The random values are independent and identically distributed (i.i.d.). Then for all $A \in \fancyA, \ i, j \in \{ 0, 1, \cdots, d_\full - 1 \}$,
\begin{equation}
    A_{i, j} \leftarrow \vlum +
    \begin{cases}
        (A_{i, j} - \vlum) \cdot \left( \unirand(A) \eta + \vlum \cdot (1 - \eta) \right) &\text{ if } \view(A) = \foreground  \\
        (A_{i, j} - \vlum) \cdot \unirand(A) &\text{ otherwise}
    \end{cases}.
\end{equation}
Thus, the luminance of the void, similar to annuli's edges as demonstrated in Equation (\ref{eq:grating}), are still assigned the luminance of $\vlum$; the mean of all pixels' luminance values is also equal to $\vlum$. An example of the resulting luminance matrix' binary heat map is visualized in Figure \ref{fig:full-stimulus-example}. The parameters' values used for composing the stimuli are displayed in Table \ref{tab:stimulus-composition-params}.

\begin{table}[!htp]
    \centering
    \input{assets/tables/stimulus-composition-params}
    \caption{The values of the parameters used to generate texture stimuli.}
    \label{tab:stimulus-composition-params}
\end{table}

\begin{figure}[!htp]
    \centering
    \input{assets/tikz-images/full-stimulus-annot}
    \caption{An example of the full stimulus with $k = 1.2$. \todo{make one with correct foreground?}}
    \label{fig:full-stimulus-example}
\end{figure}


\paragraph{Patch selection}

\todo{is the patch selected randomly?}
A patch $L$, the submatrix of $F$, of the size $\ell \times \ell$ is selected from the full stimulus $L_\full$, such that $(n | \ell) \land (\ell \leq \min(\ell_{F_w}, \ell_{F_h}))$, and the center of $L$ coincides with the center of the figure and is fully contained in it. So,
\begin{equation}
    L \coloneqq 
    \begin{pmatrix}
        L_{\full; \ceil{ O_F - \frac{\ell}{2}}, \ceil{  O_F - \frac{\ell}{2} }} &  &  \\
         & \ddots &  \\
         &  &  L_{\full; \ceil{ O_F - \frac{\ell}{2}} + \ell, \ceil{  O_F - \frac{\ell}{2}} + \ell}
    \end{pmatrix}.
\end{equation}

An example of the resulting binary heat map of the texture stimulus patch is visualized in Figure \ref{fig:stimulus-patch-example}.

\begin{figure}[!htp]
    \centering
    \hfill
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \includegraphics[width=0.9\textwidth]{assets/images/stimulus-patch.png}
        \captionof{figure}{An example of the stimulus patch.}
        \label{fig:stimulus-patch-example}
    \end{minipage}
    \hfill
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \input{assets/tikz-images/stimulus-patch-lattice}
        \captionof{figure}{An example of the $3 \times 3$ lattice applied to a stimulus patch.
        \todo{Should I make a picture of local contrasts for such a patch?}}
        \label{fig:patch-lattice-example}
    \end{minipage}
    \hfill
\end{figure}






